name: release-precompiled

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runs_on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            runs_on: ubuntu-latest
            target: x86_64-linux-gnu
          - name: macos-arm64
            runs_on: macos-15
            target: aarch64-apple-darwin

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up BEAM (Elixir/Erlang)
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.19'
          otp-version: '28'

      - name: Cache Homebrew downloads (macOS)
        if: runner.os == 'macOS'
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
          key: homebrew-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            homebrew-${{ runner.os }}-

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            clang \
            cmake \
            pkg-config \
            python3 \
            scons \
            libvulkan-dev \
            vulkan-tools \
            git \
            zip \
            unzip

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          # Vulkan on macOS is provided via MoltenVK.
          # Keep this list conservative to avoid CI breakage from formula changes.
          brew install cmake scons molten-vk vulkan-headers vulkan-loader shaderc

      - name: Build libgodot
        run: |
          ./build_libgodot.sh --release

      - name: Build and precompile NIF (elixir_make)
        run: |
          set -euo pipefail
          cd samples/elixir_sample
          mix deps.get
          # Avoid any download attempt during CI artefact generation.
          export LIBGODOT_FORCE_BUILD=1
          # Run in a single Mix invocation so the Precompiler module is compiled+loaded.
          MIX_ENV=prod mix do compile --force + elixir_make.precompile

      - name: Collect precompiled artefacts
        run: |
          set -euo pipefail
          cd samples/elixir_sample

          mkdir -p dist

          CACHE_DIR=$(MIX_ENV=prod MIX_QUIET=1 mix run --no-deps-check --no-compile --no-start -e 'IO.puts(ElixirMake.Artefact.cache_dir())' | tail -n 1)
          echo "elixir_make cache dir: ${CACHE_DIR}"

          # Copy the generated tarball + checksum sidecar(s) into dist for upload.
          cp -v "${CACHE_DIR}"/*.tar.gz dist/
          cp -v "${CACHE_DIR}"/*.tar.gz.sha256 dist/ || true

          # Also include checksum.exs written by elixir_make.precompile.
          test -f checksum.exs
          cp -v checksum.exs dist/

      - name: Verify macOS libgodot install name (from tarball)
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail
          cd samples/elixir_sample

          TAR=$(ls -1 dist/*.tar.gz | head -n 1)
          TMPDIR=$(mktemp -d)
          tar -xzf "${TAR}" -C "${TMPDIR}"
          otool -D "${TMPDIR}/libgodot.dylib" | tail -n 1 | grep -F "@rpath/libgodot.dylib"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        with:
          # This is an intermediate artefact drop created from main.
          # It is intentionally a draft/prerelease and uses a unique per-commit tag.
          draft: true
          prerelease: true
          tag_name: "draft-${{ github.sha }}"
          name: "draft-${{ github.sha }}"
          target_commitish: "${{ github.sha }}"
          files: |
            samples/elixir_sample/dist/*
